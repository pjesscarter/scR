---
title: "recidivism"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{recidivism}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
This
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(scR)
```

# Simulating VC Dimension

The `simvcd()` function provides a simulation-based method for estimating the vcd dimension of any estimation algorithm. This function relies on two helper functions, `risk_bounds()` and `loss`, also included in the package, which provide estimates of the empirical risk for a given $n$ and define the sum of squares to be minimized, respectively. In the current version of the package, the estimation algorithm must follow the syntax of taking a `formula` object and rectangular `data.frame` as input and generating a binary factor variable as output. Future versions will support other common formats, as well as the provision of user-defined helper functions for other cases. Examples of common use cases are included in this vignette. 

In order to estimate the VC dimension for a given model, the user should provide the model (along with a `list` of any packages that need to be loaded), along with its dimension (i.e. the number of predictor variables) and simulation parameters $m,k,N$, which govern the number of simulations at each design point, the number of design points, and the maximum sample size, respectively. Note that consistency requires that all three of these parameters approach infinity, so that users must choose between computation time and the accuracy of the approximation. Below is an example of estimating the VC dimension for a small (2-variable) random forest using the default parameters. 

```{r}
library(randomForest)
#simvcd(model=randomForest,dim=2,m=100,k=100,maxn=500,packages= list("randomForest"))
```

# Replication example: Predicting Recidivism

In "The accuracy, fairness, and limits of predicting recidivism", Dressel and Farid (2018) use logistic regression to predict recidivism using an abridged list of 7 features. The replication data from their paper is included with the `scR` package. Here, we demonstrate how our method can be applied to this case in order to produce an estimate of the required sample size necessary to achieve targeted levels of accuracy.

First, we show how the `simvcd` function can be used to accurately approximate the true VCD of the linear discriminant model applied in the original paper, which in this case is known to be $8$ (one more than the number of features). In this case, we must write a custom function and prediction method that takes the output of the base `glm` from R and turns it into the expected format.

```{r}
mylogit <- function(formula, data){
  m <- structure(
    glm(formula=formula,data=data,family=binomial(link="logit")),
    class=c("svrclass","glm")  #IMPORTANT - must use the class svrclass to work correctly
  )
  return(m)
}
mypred <- function(m,newdata){
  out <- predict.glm(m,newdata,type="response")
  out <- factor(ifelse(out>0.5,1,0),levels=c("0","1")) #Important - must specify levels to account for possibility of all observations being classified into the same class in smaller samples
  return(out)
}
simvcd(model=mylogit,dim=7,m=1000,k=1000,maxn=5000,predictfn = mypred) #Takes about 20 minutes to run on mid-range test machine (Intel i5-11600K CPU)
```

# Works Cited

Dressel, J. and Farid, H., 2018. The accuracy, fairness, and limits of predicting recidivism. Science advances, 4(1), p.eaao5580.